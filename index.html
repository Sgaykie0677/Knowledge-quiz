<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-6 text-gray-800">My Shopping List</h1>
        <p class="text-center text-sm text-gray-500 mb-6">User ID: <span id="userIdDisplay" class="font-mono">Loading...</span></p>

        <div id="loadingIndicator" class="text-center text-gray-500 mb-4">
            <p>Loading items...</p>
        </div>

        <ul id="shoppingList" class="space-y-4"></ul>

        <form id="addItemForm" class="mt-8 flex gap-2">
            <input type="text" id="itemInput" placeholder="Add a new item..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" required>
            <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all duration-200 shadow-md">Add Item</button>
        </form>

        <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg w-80">
                <h3 class="text-lg font-semibold mb-2" id="modal-title"></h3>
                <p class="text-gray-600 mb-4" id="modal-message"></p>
                <input type="text" id="modal-input" class="w-full p-2 mb-4 border border-gray-300 rounded-lg hidden">
                <div class="flex justify-end gap-2">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-xl hover:bg-gray-300 transition-all">Cancel</button>
                    <button id="modal-ok-btn" class="px-4 py-2 text-white bg-red-600 rounded-xl hover:bg-red-700 transition-all">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        let userLoaded = false;
        let unsubscribeFromSnapshot;

        const shoppingList = document.getElementById('shoppingList');
        const addItemForm = document.getElementById('addItemForm');
        const itemInput = document.getElementById('itemInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalInput = document.getElementById('modal-input');

        // Custom modal function to replace alert() and confirm()
        function showModal(title, message, options = {}) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalContainer.classList.remove('hidden');

                const isConfirm = options.isConfirm || false;
                const withInput = options.withInput || false;

                if (withInput) {
                    modalInput.classList.remove('hidden');
                    modalInput.value = options.inputValue || '';
                    modalOkBtn.textContent = "Save";
                    modalCancelBtn.classList.remove('hidden');
                } else {
                    modalInput.classList.add('hidden');
                    if (isConfirm) {
                        modalCancelBtn.classList.remove('hidden');
                        modalOkBtn.textContent = "Confirm";
                    } else {
                        modalCancelBtn.classList.add('hidden');
                        modalOkBtn.textContent = "OK";
                    }
                }

                const handleOk = () => {
                    modalContainer.classList.add('hidden');
                    modalOkBtn.removeEventListener('click', handleOk);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    if (withInput) {
                        resolve({ result: true, value: modalInput.value });
                    } else {
                        resolve(true);
                    }
                };

                const handleCancel = () => {
                    modalContainer.classList.add('hidden');
                    modalOkBtn.removeEventListener('click', handleOk);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    if (withInput) {
                        resolve({ result: false, value: '' });
                    } else {
                        resolve(false);
                    }
                };

                modalOkBtn.addEventListener('click', handleOk);
                modalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        // Initialize Firebase on window load
        window.onload = async function() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config not available. Cannot initialize Firebase.");
                    showModal("Error", "Firebase configuration is missing. The application will not work correctly.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                // This is the core fix: Handle authentication and data fetching within a single listener.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        userLoaded = true;
                        startListeningForData();
                    } else {
                        // User is signed out.
                        userId = null;
                        userLoaded = false;
                        userIdDisplay.textContent = 'Signing in...';

                        // Unsubscribe from any previous snapshot listener
                        if (unsubscribeFromSnapshot) {
                            unsubscribeFromSnapshot();
                        }

                        // Check if a custom auth token is available and use it first
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Custom token sign-in failed:", error);
                                // Fallback to anonymous if custom token fails
                                await signInAnonymously(auth);
                            }
                        } else {
                            // If no custom token, sign in anonymously
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showModal("Error", "Could not initialize the application. Please check the console for details.");
            }
        };

        // Function to start listening for data, called only after auth is confirmed
        function startListeningForData() {
            if (!userLoaded) return; // Guard to prevent running before user is authenticated
            
            // Set up the onSnapshot listener for the user's private shopping list
            const shoppingListRef = collection(db, `/artifacts/${appId}/users/${userId}/items`);
            unsubscribeFromSnapshot = onSnapshot(shoppingListRef, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                shoppingList.innerHTML = '';
                if (snapshot.empty) {
                    shoppingList.innerHTML = '<li class="text-center text-gray-500">Your list is empty!</li>';
                }
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm hover:shadow-md transition-all duration-200';
                    li.innerHTML = `
                        <span class="text-lg text-gray-800">${item.text}</span>
                        <div class="flex gap-2">
                            <button data-id="${doc.id}" class="update-btn text-blue-500 hover:text-blue-700 transition-colors">Edit</button>
                            <button data-id="${doc.id}" class="delete-btn text-red-500 hover:text-red-700 transition-colors">Delete</button>
                        </div>
                    `;
                    shoppingList.appendChild(li);
                });
            }, (error) => {
                console.error("Error in snapshot listener:", error);
                if (error.code === 'permission-denied') {
                    showModal("Permission Denied", "You do not have permission to access this data. This might be due to an authentication issue.");
                } else {
                    showModal("Error", "An error occurred while fetching data.");
                }
            });
        }

        // Add a new item to the shopping list
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userLoaded) {
                showModal("Wait", "Please wait while the app is loading.");
                return;
            }

            const text = itemInput.value.trim();
            if (text) {
                try {
                    const shoppingListRef = collection(db, `/artifacts/${appId}/users/${userId}/items`);
                    await addDoc(shoppingListRef, {
                        text: text,
                        createdAt: new Date()
                    });
                    itemInput.value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showModal("Error", "Failed to add the item. Please try again.");
                }
            }
        });

        // Event listener for delete and update buttons
        shoppingList.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('delete-btn')) {
                const id = target.dataset.id;
                const confirmed = await showModal("Confirm Deletion", "Are you sure you want to delete this item?", { isConfirm: true });
                if (confirmed) {
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/items`, id);
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        showModal("Error", "Failed to delete the item. Please try again.");
                    }
                }
            } else if (target.classList.contains('update-btn')) {
                const id = target.dataset.id;
                const oldText = target.closest('li').querySelector('span').textContent;
                const response = await showModal("Edit Item", "Enter new text for the item:", { withInput: true, inputValue: oldText });

                if (response.result && response.value.trim() !== '') {
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/items`, id);
                        await setDoc(docRef, { text: response.value.trim() }, { merge: true });
                    } catch (e) {
                        console.error("Error updating document: ", e);
                        showModal("Error", "Failed to update the item. Please try again.");
                    }
                }
            }
        });

    </script>
</body>
</html>
